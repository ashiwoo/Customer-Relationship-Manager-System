<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>View Cases | CRM System</title>

  <!-- Bootstrap CSS -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.8/dist/css/bootstrap.min.css" rel="stylesheet" />
  <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.1/font/bootstrap-icons.css" rel="stylesheet" />

  <!-- Custom CSS -->
  <link rel="stylesheet" href="../../css/case_management/view_case.css" />
</head>

<body class="bg-light">
  <div class="container mt-5">
    <div class="d-flex justify-content-between align-items-center mb-4">
      <h2 class="fw-bold text-primary">Customer Details</h2>
      <a href="add_case.html" class="btn btn-success">
        <i class="bi bi-plus-circle"></i> Add New Case
      </a>
    </div>

    <!-- Table -->
    <div class="card shadow-sm border-0 rounded-4">
      <div class="card-body">
        <div class="table-responsive">
          <table class="table table-striped align-middle" id="caseTable">
            <thead class="table-primary text-center">
              <tr>
                <th>ID</th>
                <th>Customer Name</th>
                <th>Email</th>
                <th>Phone</th>
                <th>Issue</th>
                <th>Status</th>
                <th>Actions</th>
              </tr>
            </thead>
            <tbody class="text-center"></tbody>
          </table>
        </div>
      </div>
    </div>
  </div>

  <!-- Edit Modal -->
  <div class="modal fade" id="editModal" tabindex="-1">
    <div class="modal-dialog modal-dialog-centered">
      <div class="modal-content rounded-4">
        <div class="modal-header bg-primary text-white rounded-top-4">
          <h5 class="modal-title">Edit Case</h5>
          <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
        </div>
        <div class="modal-body">
          <form id="updateCaseForm" method="POST">
            <input type="hidden" name="case_id" id="updateCaseId" />

            <div class="mb-3">
              <label class="form-label">Customer Name</label>
              <input type="text" id="edit_customer_name" name="customer_name" class="form-control" required />
            </div>

            <div class="mb-3">
              <label class="form-label">Email</label>
              <input type="email" id="edit_email" name="email" class="form-control" required />
            </div>

            <div class="mb-3">
              <label class="form-label">Phone</label>
              <input type="text" id="edit_phone" name="phone" class="form-control" required />
            </div>

            <div class="mb-3">
              <label class="form-label">Issue</label>
              <input type="text" id="edit_issue" name="issue" class="form-control" required />
            </div>

            <div class="mb-3">
              <label class="form-label">Status</label>
              <select id="edit_status" name="status" class="form-select">
                <option value="Open">Open</option>
                <option value="In Progress">In Progress</option>
                <option value="Resolved">Resolved</option>
              </select>
            </div>

            <div class="text-end">
              <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                Cancel
              </button>
              <button type="submit" class="btn btn-primary">Update</button>
            </div>
          </form>
        </div>
      </div>
    </div>
  </div>

  <!-- ✅ Bootstrap JS -->
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.8/dist/js/bootstrap.bundle.min.js"></script>

  <!-- ✅ Main JS -->
  <script>
    // Load cases
    async function loadCases() {
      try {
        const response = await fetch('../../../backend/case_management/api/view_case.php');
        const data = await response.json();

        const tbody = document.querySelector("#caseTable tbody");
        tbody.innerHTML = "";

        data.forEach((c) => {
          const row = document.createElement("tr");
          row.innerHTML = `
            <td>${c.id}</td>
            <td>${c.customer_name}</td>
            <td>${c.email}</td>
            <td>${c.phone}</td>
            <td>${c.issue}</td>
            <td><span class="badge bg-${
              c.status === "Resolved" ? "success" : c.status === "In Progress" ? "warning" : "secondary"
            }">${c.status}</span></td>
            <td>
              <button class="btn btn-sm btn-outline-primary me-1"
                onclick="openEditModal('${c.id}', '${c.customer_name}', '${c.email}', '${c.phone}', '${c.issue}', '${c.status}')">
                <i class="bi bi-pencil-square"></i>
              </button>
              <button class="btn btn-sm btn-outline-danger" onclick="deleteCase(${c.id})">
                <i class="bi bi-trash3-fill"></i>
              </button>
            </td>`;
          tbody.appendChild(row);
        });
      } catch (error) {
        console.error("Error loading cases:", error);
      }
    }

    // Bootstrap modal instance
    const modal = new bootstrap.Modal(document.getElementById('editModal'));

    // Open modal with case data
    function openEditModal(id, name, email, phone, issue, status) {
      document.getElementById('updateCaseId').value = id;
      document.getElementById("edit_customer_name").value = name;
      document.getElementById("edit_email").value = email;
      document.getElementById("edit_phone").value = phone;
      document.getElementById("edit_issue").value = issue;
      document.getElementById("edit_status").value = status;
      modal.show();
    }

    // Update Case
    document.getElementById("updateCaseForm").addEventListener("submit", async (e) => {
      e.preventDefault();
      const formData = new FormData(e.target);

      try {
        const response = await fetch("http://localhost/CRM_Project/backend/case_management/api/update_case.php", {
          method: "POST",
          body: formData
        });

        const text = await response.text();
        console.log("Raw response:", text);

        let result;
        try {
          result = JSON.parse(text);
        } catch {
          alert("Invalid JSON from server: " + text);
          return;
        }

        alert(result.message || "Unknown error occurred");

        if (result.success) {
          modal.hide();
          e.target.reset();
          loadCases();
        }
      } catch (error) {
        alert("Error updating case: " + error.message);
      }
    });

    // Delete Case
    async function deleteCase(id) {
      if (confirm("Are you sure you want to delete this case?")) {
        const formData = new FormData();
        formData.append("id", id);

        const response = await fetch("../../../backend/case_management/api/delete_case.php", {
          method: "POST",
          body: formData
        });

        const result = await response.json();
        alert(result.message);
        loadCases();
      }
    }

    // Load cases initially
    loadCases();
  </script>
</body>
</html>
